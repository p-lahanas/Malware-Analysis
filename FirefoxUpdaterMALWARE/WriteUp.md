# **Firefox Updater... supposedly**

## **Background**
One simple google search the other day resulted in a drive-by download on my machine. Rather than delete the file and move on with my life, I thought it would be fun to investigate the mysterious "Firefox.Quick.Update.ver.102.40.91878.js" that appeared on my system. I've never really analysed malware before but anyway, here we go. 

## **First Impressions**
For those of you playing along at home, the original javascript file is included in this directory and is title "Firefox.Quick.Update.ver.102.40.91878.js". I have removed the sketchy URL so that no one gets hurt and replaced it with the text "THE SKETCHY URL". 

First thing is I wanted to rule out that this might be a legitimate update so I opened the document in my trusty text editor. Yep, something is a bit suss here as I see some attempts at obfuscation. My next thought process is to see if VirusTotal has any insight.

![VirusTotal](images/Virustotal.png)

Some vendors reported the file as malicious and potentially a trojan? Anyway, let's start looking at the code.

## **The Code**
First thing I did was to try and tidy up everything which was obvious, like this...
### Before
![Before](images/before.png)  
### After  
![After](images/After.png)  
For example the obfuscation of the string "ActiveXObject" is a bit of a cop out. Like somebody who doesn't even program could probably figure out what that's supposed to be. 
For an antivirus though, it's likely to be a bit more of a challenge.

Straight away the ActiveXObject is a bit of a giveway that this script uses the ActiveXObject API which is only supported by internet explorer on windows. From here, I pretty much followed the call stack from the bottom two lines and figure out that the code constructs an HTTP request to "THE SKETCHY URL". You can see my modified function and variable names in "modified.js". Nothing too tricky here.  
What was pretty cool is that the original sketchy URL is obfuscated with a simple function that is decoded by grabbing every second character in reverse order of the string. I was able to copy this in python, passing the encoded sketchy URL, giving me the actual location.

## **The Stager**
From the quick analysis of the code, we can see that this script is probably a stager, which will download the larger payload from our URL and then run this in the javascript interpreter. I really want to have a look at what the payload is going to be so let's try and grab the information as securely as possible.  

Let's fire up the Kali Linux VM and see what the exact request we are supposed to send is. My thought process is to just run the code in my browser using Burp to intercept the requests then I know exactly what is being sent to the server.